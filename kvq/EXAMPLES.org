#+TITLE: kvq Usage Examples
#+AUTHOR: KVL Team
#+DATE: 2025-01-20

* Basic Usage Examples

** Simple Value Access
#+BEGIN_SRC bash
# config.kvl:
# name = My Application
# version = 1.0.0

kvq config.kvl name
# Output: My Application

kvq config.kvl version  
# Output: 1.0.0
#+END_SRC

** Nested Object Access
#+BEGIN_SRC bash
# server.kvl:
# database =
#   host = localhost
#   port = 5432
#   ssl = true

kvq server.kvl database.host
# Output: localhost

kvq server.kvl database.port
# Output: 5432
#+END_SRC

** Array Operations
#+BEGIN_SRC bash
# tags.kvl:
# features = authentication
# features = authorization  
# features = logging

kvq tags.kvl features[]
# Output (one per line):
# authentication
# authorization
# logging

kvq tags.kvl features[0]
# Output: authentication

kvq tags.kvl features[-1]
# Output: logging

kvq tags.kvl features[1:3]
# Output (one per line):
# authorization
# logging
#+END_SRC

* Advanced Query Examples

** Complex Nested Structures
#+BEGIN_SRC bash
# servers.kvl:
# servers =
#   = name = web1
#     host = 192.168.1.10
#     port = 80
#     tags = frontend
#     tags = nginx
#   = name = web2  
#     host = 192.168.1.11
#     port = 8080
#     tags = frontend
#     tags = nodejs

# Get all server names
kvq servers.kvl servers[].name
# Output (one per line):
# web1
# web2

# Get first server's host
kvq servers.kvl servers[0].host
# Output: 192.168.1.10

# Get all tags from all servers
kvq servers.kvl servers[].tags[]
# Output (one per line):
# frontend
# nginx
# frontend
# nodejs
#+END_SRC

** Pipe Functions
#+BEGIN_SRC bash
# scores.kvl:
# math = 95
# math = 87
# math = 92
# english = 88
# english = 91
# english = 89

# Count math scores
kvq scores.kvl math[] | length
# Output: 3

# Find highest math score
kvq scores.kvl math | max
# Output: 95

# Sum all math scores
kvq scores.kvl math | sum
# Output: 274

# Get all subject names
kvq scores.kvl . | keys
# Output (one per line):
# math
# english
#+END_SRC

** List Marker Syntax
#+BEGIN_SRC bash
# modern.kvl:
# #= kvl 1.0 -
# tasks =
# - design
# - implement
# - test
# - deploy

kvq modern.kvl tasks[]
# Output (one per line):
# design
# implement  
# test
# deploy

kvq modern.kvl tasks[1:3]
# Output (one per line):
# implement
# test
#+END_SRC

* Output Format Examples

** JSON Output
#+BEGIN_SRC bash
# server.kvl:
# database =
#   host = localhost
#   port = 5432

kvq --json server.kvl database
# Output: {"host": "localhost", "port": "5432"}

kvq --json --compact server.kvl database  
# Output: {"host":"localhost","port":"5432"}
#+END_SRC

** KVL Output
#+BEGIN_SRC bash
kvq --kvl server.kvl database
# Output:
# host = localhost
# port = 5432
#+END_SRC

** Raw Output
#+BEGIN_SRC bash
kvq --raw server.kvl database.host
# Output: localhost (no quotes)

kvq --raw server.kvl features[]
# Output (one per line, no quotes):
# authentication
# authorization
# logging
#+END_SRC

* Multiple File Examples

** Configuration Merging
#+BEGIN_SRC bash
# base.kvl:
# app =
#   name = MyApp
#   debug = false

# local.kvl:  
# app =
#   debug = true
#   port = 3000

# Merge files and query
kvq base.kvl local.kvl app.debug
# Output: true

kvq base.kvl local.kvl app
# Output (KVL format):
# name = MyApp
# debug = true
# port = 3000
#+END_SRC

** Environment-Specific Configs
#+BEGIN_SRC bash
# defaults.kvl:
# database =
#   host = localhost
#   port = 5432
# cache =
#   ttl = 3600

# production.kvl:
# database =
#   host = prod-db.example.com
#   ssl = true
# cache =
#   ttl = 7200

kvq defaults.kvl production.kvl database.host
# Output: prod-db.example.com

kvq defaults.kvl production.kvl cache.ttl
# Output: 7200
#+END_SRC

* Standard Input Examples

** Pipeline Processing
#+BEGIN_SRC bash
# Read from stdin
cat config.kvl | kvq server.port

# Process multiple queries
echo "name = test" | kvq -- name . | keys

# Chain with other Unix tools
kvq servers.kvl servers[].port | sort -n | tail -1
#+END_SRC

** Error Handling Examples
#+BEGIN_SRC bash
# Missing key
kvq config.kvl missing.key
# Error: Key 'missing' not found
# Exit code: 1

# Invalid syntax
kvq config.kvl 'server.[invalid'
# Error: Invalid query syntax at position 8
# Exit code: 2

# File not found
kvq missing.kvl server.host
# Error: File not found: missing.kvl  
# Exit code: 3
#+END_SRC

* Practical Use Cases

** Service Discovery
#+BEGIN_SRC bash
# services.kvl:
# services =
#   = name = api
#     host = api.internal
#     port = 8080
#     health_check = /health
#   = name = cache
#     host = cache.internal  
#     port = 6379

# Get all service URLs
kvq services.kvl services[] | 
  while read -r service; do
    host=$(echo "$service" | kvq - host)
    port=$(echo "$service" | kvq - port)
    echo "http://$host:$port"
  done
#+END_SRC

** Configuration Validation
#+BEGIN_SRC bash
# Check required fields exist
required_fields="database.host database.port app.secret_key"
for field in $required_fields; do
  if ! kvq config.kvl "$field" >/dev/null 2>&1; then
    echo "Missing required field: $field"
    exit 1
  fi
done
#+END_SRC

** Monitoring and Alerting
#+BEGIN_SRC bash
# metrics.kvl:
# servers =
#   = name = web1
#     cpu = 85
#     memory = 78
#   = name = web2
#     cpu = 92
#     memory = 89

# Find servers with high CPU
kvq metrics.kvl servers[] |
  while read -r server; do
    cpu=$(echo "$server" | kvq - cpu)
    name=$(echo "$server" | kvq - name)
    if [ "$cpu" -gt 90 ]; then
      echo "ALERT: $name CPU usage: ${cpu}%"
    fi
  done
#+END_SRC

** Build and Deployment
#+BEGIN_SRC bash
# build.kvl:
# environments =
#   = name = staging
#     url = https://staging.example.com
#     branch = develop
#   = name = production
#     url = https://example.com  
#     branch = main

# Deploy to specific environment
ENV="production"
URL=$(kvq build.kvl "environments[] | select(.name == \"$ENV\").url")
BRANCH=$(kvq build.kvl "environments[] | select(.name == \"$ENV\").branch")

echo "Deploying $BRANCH to $URL"
#+END_SRC

* Performance Examples

** Large File Processing
#+BEGIN_SRC bash
# Process large configuration files efficiently
kvq large-config.kvl servers[].name | head -10

# Count elements without loading everything into memory
kvq large-config.kvl servers[] | wc -l

# Find specific items quickly
kvq large-config.kvl servers[] | grep "web.*"
#+END_SRC

** Streaming Processing
#+BEGIN_SRC bash
# Process configuration stream
tail -f config-updates.kvl | kvq --raw - latest.timestamp

# Real-time monitoring
while true; do
  STATUS=$(kvq health.kvl service.status)
  echo "$(date): Service status is $STATUS"
  sleep 5
done
#+END_SRC

These examples demonstrate the practical applications of kvq in real-world scenarios, from simple configuration queries to complex deployment automation.